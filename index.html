<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma√Ætre Sall ‚Äì Conseiller Juridique AI | S√©n√©gal</title>
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --bg-sidebar: #111418;
      --bg-input: #1c2128;
      --border: #30363d;
      --gold: #c9a84c;
      --gold-light: #e0c068;
      --gold-dim: rgba(201,168,76,0.12);
      --blue: #1f6feb;
      --green: #238636;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --user-bg: #1f3c5a;
      --ai-bg: #161b22;
      --consultation-bg: rgba(201,168,76,0.05);
      --error: #f85149;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      height: 100dvh;
    }

    /* === SIDEBAR === */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px 16px;
      gap: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }
    .logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }
    .logo-text h1 {
      font-size: 15px;
      font-weight: 700;
      color: var(--gold-light);
      line-height: 1.2;
    }
    .logo-text p { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    .new-conv-btn {
      background: var(--gold);
      color: #000;
      border: none;
      border-radius: var(--radius-sm);
      padding: 11px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .new-conv-btn:hover { background: var(--gold-light); }

    .sidebar-section { border-top: 1px solid var(--border); padding-top: 16px; }
    .sidebar-section h3 { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }

    .mode-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 8px;
    }
    .mode-card .mode-icon { font-size: 18px; margin-bottom: 6px; }
    .mode-card h4 { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .mode-card p { font-size: 11px; color: var(--text-secondary); margin-top: 4px; line-height: 1.5; }
    .mode-card.active { border-color: var(--gold); background: var(--gold-dim); }

    .codes-list { list-style: none; }
    .codes-list li {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 3px 0;
      border-left: 2px solid var(--border);
      padding-left: 8px;
      margin-bottom: 2px;
    }

    .settings-group { margin-bottom: 12px; }
    .settings-group label { font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 6px; }
    .settings-group input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 11px;
      padding: 8px 10px;
      outline: none;
    }
    .settings-group input:focus { border-color: var(--gold); }

    .voice-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .toggle-switch.on { background: var(--gold); }
    .toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle-switch.on .toggle-knob { transform: translateX(16px); }

    /* === MAIN AREA === */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: var(--bg-sidebar);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
    .status-dot.offline { background: var(--error); }
    .mode-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid;
      transition: all 0.3s;
    }
    .mode-badge.question { color: #58a6ff; border-color: #1f6feb; background: rgba(31,111,235,0.1); }
    .mode-badge.consultation { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }

    /* Chat area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }
    .chat-area::-webkit-scrollbar { width: 6px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Welcome */
    .welcome {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .welcome-icon { font-size: 56px; margin-bottom: 16px; }
    .welcome h2 { font-size: 22px; font-weight: 700; color: var(--gold-light); margin-bottom: 10px; }
    .welcome p { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
    .welcome-examples { display: flex; flex-direction: column; gap: 8px; text-align: left; }
    .example-chip {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1.4;
    }
    .example-chip:hover { border-color: var(--gold); color: var(--text-primary); background: var(--gold-dim); }
    .example-chip strong { color: var(--gold); display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }

    /* Messages */
    .message { display: flex; gap: 12px; align-items: flex-start; max-width: 85%; }
    .message.user { flex-direction: row-reverse; align-self: flex-end; }
    .message.ai { align-self: flex-start; }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .avatar.ai-avatar { background: linear-gradient(135deg, #1a2a1a, #2a3a1a); border: 1px solid var(--gold); }
    .avatar.user-avatar { background: var(--user-bg); border: 1px solid var(--blue); font-size: 14px; }

    .bubble {
      padding: 14px 18px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.6;
      max-width: 100%;
    }
    .message.user .bubble {
      background: var(--user-bg);
      border: 1px solid rgba(31,111,235,0.3);
      border-top-right-radius: 4px;
    }
    .message.ai .bubble {
      background: var(--ai-bg);
      border: 1px solid var(--border);
      border-top-left-radius: 4px;
    }
    .bubble.consultation-bubble { background: var(--consultation-bg); border-color: rgba(201,168,76,0.2); }

    /* Consultation structured response */
    .analysis-container { display: flex; flex-direction: column; gap: 12px; }
    .analysis-section {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    .analysis-header {
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .analysis-header:hover { background: rgba(255,255,255,0.03); }
    .analysis-header.faits { border-left: 3px solid #58a6ff; color: #58a6ff; }
    .analysis-header.problemes { border-left: 3px solid #f0883e; color: #f0883e; }
    .analysis-header.textes { border-left: 3px solid var(--gold); color: var(--gold); }
    .analysis-header.analyse { border-left: 3px solid #3fb950; color: #3fb950; }
    .analysis-header.orientations { border-left: 3px solid #a371f7; color: #a371f7; }
    .analysis-header.garde { border-left: 3px solid var(--error); color: var(--error); background: rgba(248,81,73,0.05); }
    .analysis-body {
      padding: 12px 14px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.7;
      border-top: 1px solid var(--border);
    }
    .analysis-toggle { margin-left: auto; font-size: 11px; color: var(--text-muted); }

    /* Markdown in bubbles */
    .bubble-text p { margin-bottom: 8px; }
    .bubble-text p:last-child { margin-bottom: 0; }
    .bubble-text strong { color: var(--text-primary); }
    .bubble-text ul, .bubble-text ol { padding-left: 20px; margin: 6px 0; }
    .bubble-text li { margin-bottom: 4px; }
    .bubble-text code {
      background: rgba(255,255,255,0.08);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }

    /* Typing indicator */
    .typing-indicator { display: flex; align-items: center; gap: 6px; padding: 14px 18px; }
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--gold);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
      opacity: 0.6;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%, 80%, 100% { transform: scale(1); opacity: 0.6; } 40% { transform: scale(1.3); opacity: 1; } }

    /* Input area */
    .input-area {
      background: var(--bg-sidebar);
      border-top: 1px solid var(--border);
      padding: 16px 24px;
      flex-shrink: 0;
    }
    .input-disclaimer {
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 10px;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      transition: border-color 0.2s;
    }
    .input-row:focus-within { border-color: var(--gold); }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      min-height: 22px;
      line-height: 1.5;
    }
    #messageInput::placeholder { color: var(--text-muted); }

    .input-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 18px;
      flex-shrink: 0;
    }
    .input-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
    .input-btn:disabled { opacity: 0.3; cursor: default; }

    .send-btn {
      background: var(--gold);
      color: #000;
      border-radius: 8px;
      font-size: 16px;
    }
    .send-btn:hover { background: var(--gold-light); color: #000; }
    .send-btn:disabled { background: var(--border); color: var(--text-muted); }

    .mic-btn.recording {
      color: var(--error);
      animation: micPulse 1s infinite;
    }
    @keyframes micPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 320px;
    }
    .notification.error { background: #3d1a1a; border: 1px solid var(--error); color: #ffa0a0; }
    .notification.success { background: #1a3d1a; border: 1px solid var(--green); color: #80ff80; }
    .notification.info { background: #1a2a3d; border: 1px solid var(--blue); color: #80c0ff; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Hamburger button */
    .hamburger {
      display: none;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      font-size: 20px;
      flex-shrink: 0;
      line-height: 1;
    }
    .hamburger:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }

    /* Sidebar overlay (mobile) */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 99;
    }
    .sidebar-overlay.visible { display: block; }

    /* Sidebar close button (mobile) */
    .sidebar-close {
      display: none;
      position: absolute;
      top: 14px;
      right: 14px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
    }
    .sidebar-close:hover { color: var(--text-primary); }

    /* Responsive */
    @media (max-width: 768px) {
      /* Show hamburger */
      .hamburger { display: flex; align-items: center; justify-content: center; }
      .sidebar-close { display: block; }

      /* Sidebar: hidden by default, slides in */
      .sidebar {
        width: 0;
        min-width: 0;
        padding: 0;
        overflow: hidden;
        position: fixed;
        z-index: 100;
        height: 100%;
        height: 100dvh;
        top: 0;
        left: 0;
        transition: width 0.25s ease, padding 0.25s ease;
      }
      .sidebar.open {
        width: 280px;
        min-width: 280px;
        padding: 20px 16px;
      }

      /* Header */
      .header { padding: 12px 14px; }
      .header-left { gap: 8px; }

      /* Compact title on mobile */
      .header-title-text { font-size: 12px !important; }
      .header-title-sub { display: none; }

      /* Chat area */
      .chat-area { padding: 12px; gap: 12px; }

      /* Messages */
      .message { max-width: 100%; }
      .avatar { width: 30px; height: 30px; font-size: 14px; }
      .bubble { padding: 10px 14px; font-size: 13px; }

      /* Welcome */
      .welcome { padding: 20px 8px; }
      .welcome-icon { font-size: 40px; }
      .welcome h2 { font-size: 18px; }
      .welcome p { font-size: 13px; }
      .example-chip { font-size: 11px; padding: 8px 12px; }

      /* Input area ‚Äì cl√© pour la visibilit√© mobile */
      .input-area { padding: 10px 12px; }
      .input-row { padding: 8px 10px; gap: 8px; }
      #messageInput { font-size: 16px; /* 16px √©vite le zoom auto sur iOS */ }
      .input-disclaimer { font-size: 9px; margin-bottom: 6px; }

      /* Notification */
      .notification { right: 10px; left: 10px; max-width: none; }
    }

    @media (max-width: 400px) {
      .mode-badge { display: none; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR OVERLAY (mobile) -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" style="position:relative;">
    <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
    <div class="logo">
      <div class="logo-icon">‚öñÔ∏è</div>
      <div class="logo-text">
        <h1>Ma√Ætre Sall</h1>
        <p>Conseiller Juridique AI</p>
      </div>
    </div>

    <button class="new-conv-btn" onclick="newConversation()">
      <span>+</span> Nouveau Dossier
    </button>

    <div class="sidebar-section">
      <h3>Modes</h3>
      <div class="mode-card" id="card-question">
        <div class="mode-icon">üîµ</div>
        <h4>Question Juridique</h4>
        <p>Posez une question sur le droit s√©n√©galais et obtenez une r√©ponse pr√©cise.</p>
      </div>
      <div class="mode-card" id="card-consultation">
        <div class="mode-icon">üü°</div>
        <h4>Consultation Juridique</h4>
        <p>Exposez votre situation et recevez une analyse juridique structur√©e en 6 parties.</p>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Codes Disponibles</h3>
      <ul class="codes-list">
        <li>Code P√©nal</li>
        <li>Code de Proc√©dure P√©nale</li>
        <li>Code Civil</li>
        <li>Code de Proc√©dure Civile</li>
        <li>Code du Travail</li>
        <li>Code de la Famille</li>
        <li>COCC</li>
        <li>Code Minier 2016</li>
        <li>Code de l'Environnement</li>
        <li>Code G√©n√©ral des Imp√¥ts</li>
        <li>Code des Douanes</li>
        <li>Constitution 2001</li>
      </ul>
    </div>

    <div class="sidebar-section">
      <h3>Param√®tres</h3>
      <div class="settings-group">
        <label>URL du Webhook N8N</label>
        <input type="text" id="webhookUrl" placeholder="https://...webhook/conseiller-juridique-ai"
          value="">
      </div>
      <label class="voice-toggle" onclick="toggleVoice()">
        <div class="toggle-switch" id="voiceToggle">
          <div class="toggle-knob"></div>
        </div>
        R√©ponses vocales
      </label>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="header">
      <div class="header-left">
        <button class="hamburger" onclick="openSidebar()" title="Menu">‚ò∞</button>
        <div class="header-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Pr√™t</span>
        </div>
      </div>
      <div style="text-align:center; flex:1;">
        <span class="header-title-text" style="font-size:13px; font-weight:600; color:var(--gold-light);">‚öñÔ∏è Ma√Ætre Sall ‚Äì Conseiller Juridique AI</span>
        <br><span class="header-title-sub" style="font-size:11px; color:var(--text-muted);">Droit S√©n√©galais ¬∑ 12 Codes L√©gaux</span>
      </div>
      <div class="mode-badge question" id="modeBadge">Question</div>
    </header>

    <div class="chat-area" id="chatArea">
      <!-- Welcome -->
      <div class="welcome" id="welcome">
        <div class="welcome-icon">‚öñÔ∏è</div>
        <h2>Bienvenue, je suis Ma√Ætre Sall</h2>
        <p>Votre conseiller juridique IA, expert en droit s√©n√©galais.<br>
        Je peux r√©pondre √† vos <strong style="color:#58a6ff">questions de droit</strong> ou analyser
        votre <strong style="color:var(--gold)">situation juridique</strong> et vous proposer des orientations.</p>
        <div class="welcome-examples">
          <div class="example-chip" onclick="sendExample(this.dataset.q)" data-q="Quelle est la dur√©e l√©gale de la garde √† vue au S√©n√©gal ?">
            <strong>üîµ Question Juridique</strong>
            Quelle est la dur√©e l√©gale de la garde √† vue au S√©n√©gal ?
          </div>
          <div class="example-chip" onclick="sendExample(this.dataset.q)" data-q="Mon employeur m'a licenci√© sans pr√©avis apr√®s 5 ans de service. Il refuse de me payer mes indemnit√©s et a d√©truit mon contrat de travail.">
            <strong>üü° Consultation ‚Äì Droit du Travail</strong>
            Mon employeur m'a licenci√© sans pr√©avis apr√®s 5 ans de service. Il refuse de me payer mes indemnit√©s et a d√©truit mon contrat de travail.
          </div>
          <div class="example-chip" onclick="sendExample(this.dataset.q)" data-q="J'ai sign√© un contrat de bail il y a 3 ans. Mon propri√©taire veut m'expulser sans motif et a coup√© l'eau et l'√©lectricit√© pour me forcer √† partir.">
            <strong>üü° Consultation ‚Äì Droit Immobilier</strong>
            J'ai sign√© un contrat de bail il y a 3 ans. Mon propri√©taire veut m'expulser sans motif et a coup√© l'eau et l'√©lectricit√© pour me forcer √† partir.
          </div>
          <div class="example-chip" onclick="sendExample(this.dataset.q)" data-q="Quels sont les articles applicables au divorce par consentement mutuel dans le Code de la Famille s√©n√©galais ?">
            <strong>üîµ Question Juridique</strong>
            Quels sont les articles applicables au divorce par consentement mutuel ?
          </div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-disclaimer">
        ‚ö†Ô∏è Usage informatif uniquement ‚Äì Consultez un avocat pour vos affaires juridiques
      </div>
      <div class="input-row">
        <textarea id="messageInput" placeholder="Posez une question ou exposez votre situation juridique..." rows="1"
          onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
        <button class="input-btn mic-btn" id="micBtn" onclick="toggleRecording()" title="Entr√©e vocale">
          üé§
        </button>
        <button class="input-btn send-btn" id="sendBtn" onclick="sendMessage()" title="Envoyer">
          ‚û§
        </button>
      </div>
    </div>
  </main>

  <script>
    // ========== STATE ==========
    let isRecording = false;
    let recognition = null;
    let voiceOutputEnabled = true;
    let currentSpeech = null;
    let history = [];
    let sessionId = 'session_' + Date.now();
    let isLoading = false;

    // Default webhook URL ‚Äì update after workflow activation
    const DEFAULT_WEBHOOK = 'https://mmdrame2017.app.n8n.cloud/webhook/conseiller-juridique-ai';

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Reset stale URL if it doesn't match the current instance
      const saved = localStorage.getItem('cj_webhook_url');
      if (saved && saved.includes('mmdrame2017')) {
        document.getElementById('webhookUrl').value = saved;
      } else {
        // Clear stale value and use default
        localStorage.removeItem('cj_webhook_url');
        document.getElementById('webhookUrl').value = DEFAULT_WEBHOOK;
      }

      const savedVoice = localStorage.getItem('cj_voice_output');
      voiceOutputEnabled = savedVoice !== 'false';
      updateVoiceToggle();

      setupSpeechRecognition();

      // Warn if opened as file:// (CORS will block requests)
      if (location.protocol === 'file:') {
        showNotification('‚ö†Ô∏è Ouvrez ce fichier via un serveur (localhost) pour √©viter les erreurs CORS', 'error');
      }
    });

    function getWebhookUrl() {
      const url = document.getElementById('webhookUrl').value.trim();
      localStorage.setItem('cj_webhook_url', url);
      return url || DEFAULT_WEBHOOK;
    }

    // ========== SIDEBAR MOBILE ==========
    function openSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('sidebarOverlay').classList.add('visible');
      document.body.style.overflow = 'hidden';
    }
    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('visible');
      document.body.style.overflow = '';
    }

    // ========== VOICE TOGGLE ==========
    function toggleVoice() {
      voiceOutputEnabled = !voiceOutputEnabled;
      localStorage.setItem('cj_voice_output', voiceOutputEnabled);
      updateVoiceToggle();
      if (!voiceOutputEnabled && currentSpeech) { window.speechSynthesis.cancel(); }
    }
    function updateVoiceToggle() {
      const toggle = document.getElementById('voiceToggle');
      toggle.classList.toggle('on', voiceOutputEnabled);
    }

    // ========== SPEECH RECOGNITION ==========
    function setupSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        document.getElementById('micBtn').style.display = 'none';
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = 'fr-FR';
      recognition.continuous = false;
      recognition.interimResults = true;

      recognition.onresult = (event) => {
        const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
        document.getElementById('messageInput').value = transcript;
        autoResize(document.getElementById('messageInput'));
        if (event.results[event.results.length - 1].isFinal) {
          stopRecording();
          setTimeout(() => sendMessage(), 300);
        }
      };
      recognition.onerror = () => stopRecording();
      recognition.onend = () => stopRecording();
    }

    function toggleRecording() {
      if (isRecording) { stopRecording(); }
      else { startRecording(); }
    }
    function startRecording() {
      if (!recognition) { showNotification('Reconnaissance vocale non support√©e', 'error'); return; }
      if (currentSpeech) { window.speechSynthesis.cancel(); }
      isRecording = true;
      document.getElementById('micBtn').classList.add('recording');
      document.getElementById('micBtn').title = 'Arr√™ter l\'enregistrement';
      recognition.start();
    }
    function stopRecording() {
      isRecording = false;
      document.getElementById('micBtn').classList.remove('recording');
      document.getElementById('micBtn').title = 'Entr√©e vocale';
      try { if (recognition) recognition.stop(); } catch(e) {}
    }

    // ========== SPEECH SYNTHESIS ==========
    // D√©coupe un texte en segments courts √† la fronti√®re des phrases
    function splitIntoChunks(text, maxLen) {
      const chunks = [];
      const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l.length > 0);
      for (const line of lines) {
        if (line.length <= maxLen) { chunks.push(line); continue; }
        const sentences = line.split(/(?<=[.!?;,])\s+/);
        let buffer = '';
        for (const s of sentences) {
          const candidate = buffer ? buffer + ' ' + s : s;
          if (candidate.length <= maxLen) {
            buffer = candidate;
          } else {
            if (buffer) chunks.push(buffer);
            buffer = s.length <= maxLen ? s : s.slice(0, maxLen);
          }
        }
        if (buffer) chunks.push(buffer);
      }
      return chunks.filter(c => c.trim().length > 0);
    }

    function speakText(text) {
      if (!voiceOutputEnabled) return;
      window.speechSynthesis.cancel();

      // Nettoie le texte (markdown, emojis, balises contexte)
      let cleanText = text
        .replace(/^#{1,3}\s+[^\n]+/gm, '')
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/\*([^*]+)\*/g, '$1')
        .replace(/[\u{1F300}-\u{1FFFF}]/gu, '')
        .replace(/===.*?===/gs, '')
        .replace(/\[Source:[^\]]+\]/g, '')
        .replace(/\n{3,}/g, '\n\n')
        .trim();

      if (!cleanText) return;

      // R√©cup√®re la voix fran√ßaise une seule fois
      const voices = window.speechSynthesis.getVoices();
      const frVoice = voices.find(v => v.lang.startsWith('fr') && !v.name.includes('Google'))
        || voices.find(v => v.lang.startsWith('fr'));

      // D√©coupe en chunks de 250 chars max pour √©viter la coupure navigateur
      const chunks = splitIntoChunks(cleanText, 250);
      let chunkIndex = 0;

      function speakNext() {
        if (chunkIndex >= chunks.length) { currentSpeech = null; return; }
        const utterance = new SpeechSynthesisUtterance(chunks[chunkIndex++]);
        utterance.lang = 'fr-FR';
        utterance.rate = 0.95;
        utterance.pitch = 1;
        if (frVoice) utterance.voice = frVoice;
        utterance.onend = speakNext;
        utterance.onerror = speakNext; // passe au suivant en cas d'erreur
        currentSpeech = utterance;
        window.speechSynthesis.speak(utterance);
      }

      speakNext();
    }

    // ========== CHAT LOGIC ==========
    async function sendMessage() {
      if (isLoading) return;
      closeSidebar(); // ferme la sidebar sur mobile si ouverte
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      autoResize(input);
      hideWelcome();

      addUserMessage(message);
      showTyping();

      history.push({ role: 'user', content: message });
      isLoading = true;
      setStatus(true);

      try {
        const webhookUrl = getWebhookUrl();
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, session_id: sessionId, history: history.slice(-6) })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        removeTyping();
        const aiResponse = data.response || data.text || data.output || 'D√©sol√©, je n\'ai pas pu traiter votre demande.';
        const inputType = data.type || detectType(message);

        addAiMessage(aiResponse, inputType);
        history.push({ role: 'assistant', content: aiResponse });
        updateModeBadge(inputType);
        speakText(aiResponse);

      } catch (err) {
        removeTyping();
        const errMsg = 'Erreur de connexion. V√©rifiez l\'URL du webhook et que le workflow est actif.';
        addAiMessage(errMsg, 'question');
        showNotification('Erreur: ' + err.message, 'error');
      } finally {
        isLoading = false;
        setStatus(false);
      }
    }

    function sendExample(text) {
      document.getElementById('messageInput').value = text;
      autoResize(document.getElementById('messageInput'));
      sendMessage();
    }

    // ========== DOM HELPERS ==========
    function hideWelcome() {
      const w = document.getElementById('welcome');
      if (w) w.style.display = 'none';
    }

    function addUserMessage(text) {
      const div = document.createElement('div');
      div.className = 'message user';
      div.innerHTML = `
        <div class="avatar user-avatar">üë§</div>
        <div class="bubble">
          <div class="bubble-text">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
        </div>`;
      document.getElementById('chatArea').appendChild(div);
      scrollToBottom();
    }

    function addAiMessage(text, type) {
      const div = document.createElement('div');
      div.className = 'message ai';

      if (type === 'consultation') {
        // Parse structured sections
        div.innerHTML = `
          <div class="avatar ai-avatar">‚öñÔ∏è</div>
          <div class="bubble consultation-bubble" style="padding:16px; min-width:320px;">
            <div style="font-size:11px; color:var(--gold); margin-bottom:12px; font-weight:600;">
              üü° CONSULTATION JURIDIQUE
            </div>
            ${renderConsultation(text)}
          </div>`;
      } else {
        div.innerHTML = `
          <div class="avatar ai-avatar">‚öñÔ∏è</div>
          <div class="bubble">
            <div style="font-size:11px; color:#58a6ff; margin-bottom:8px; font-weight:600;">
              üîµ R√âPONSE JURIDIQUE
            </div>
            <div class="bubble-text">${parseMarkdown(text)}</div>
          </div>`;
      }

      document.getElementById('chatArea').appendChild(div);
      scrollToBottom();
    }

    function renderConsultation(text) {
      const sections = [
        { key: 'üîç', label: 'Analyse des Faits', cls: 'faits', patterns: ['ANALYSE DES FAITS', 'analyse des faits', 'FAITS'] },
        { key: '‚öñÔ∏è', label: 'Probl√®mes Juridiques', cls: 'problemes', patterns: ['PROBL', 'probl√®mes', 'JURIDIQUES SOUL'] },
        { key: 'üìö', label: 'Textes Applicables', cls: 'textes', patterns: ['TEXTES APPLICABLES', 'textes applicables', 'TEXTES'] },
        { key: 'üí°', label: 'Analyse Juridique', cls: 'analyse', patterns: ['ANALYSE JURIDIQUE', 'analyse juridique', 'INTERPR√âTATION'] },
        { key: 'üéØ', label: 'Orientations & Recommandations', cls: 'orientations', patterns: ['ORIENTATIONS', 'orientations', 'RECOMMANDATIONS'] },
        { key: '‚ö†Ô∏è', label: 'Mise en Garde', cls: 'garde', patterns: ['MISE EN GARDE', 'mise en garde', 'AVERTISSEMENT'] }
      ];

      // Try to split by sections
      let html = '<div class="analysis-container">';
      const remaining = splitIntoSections(text, sections);

      if (remaining.parsed) {
        for (const [sKey, content] of Object.entries(remaining.sections)) {
          const sec = sections.find(s => s.cls === sKey);
          if (!sec || !content.trim()) continue;
          html += `
            <div class="analysis-section">
              <div class="analysis-header ${sec.cls}" onclick="toggleSection(this)">
                ${sec.key} ${sec.label}
                <span class="analysis-toggle">‚ñº</span>
              </div>
              <div class="analysis-body">${parseMarkdown(content.trim())}</div>
            </div>`;
        }
      } else {
        // Fallback: render as markdown
        html += `<div class="bubble-text">${parseMarkdown(text)}</div>`;
      }

      html += '</div>';
      return html;
    }

    function splitIntoSections(text, sections) {
      // Build a pattern to split on ## headers or emoji headers
      const headerPattern = /^(?:#{1,3}\s+)?(?:[üîç‚öñÔ∏èüìöüí°üéØ‚ö†Ô∏è]\s+)?(?:ANALYSE DES FAITS|PROBL√àMES JURIDIQUES|TEXTES APPLICABLES|ANALYSE JURIDIQUE|ORIENTATIONS|MISE EN GARDE|PROBL[√àE]MES|RECOMMANDATIONS)/im;

      if (!headerPattern.test(text)) {
        return { parsed: false, sections: {} };
      }

      const result = { parsed: true, sections: { faits: '', problemes: '', textes: '', analyse: '', orientations: '', garde: '' } };

      const lines = text.split('\n');
      let currentSection = null;

      for (const line of lines) {
        const lineTrimmed = line.trim().toLowerCase();
        const lineUpper = line.toUpperCase();

        let matched = false;
        for (const sec of sections) {
          if (sec.patterns.some(p => lineUpper.includes(p.toUpperCase()) && line.match(/^#{1,3}|^[üîç‚öñÔ∏èüìöüí°üéØ‚ö†Ô∏è]/))) {
            currentSection = sec.cls;
            matched = true;
            break;
          }
        }
        if (!matched && currentSection) {
          result.sections[currentSection] += line + '\n';
        }
      }

      // Check if we parsed anything
      const hasContent = Object.values(result.sections).some(v => v.trim().length > 0);
      if (!hasContent) return { parsed: false, sections: {} };

      return result;
    }

    function toggleSection(header) {
      const body = header.nextElementSibling;
      const toggle = header.querySelector('.analysis-toggle');
      if (body.style.display === 'none') {
        body.style.display = 'block';
        toggle.textContent = '‚ñº';
      } else {
        body.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }

    function showTyping() {
      const div = document.createElement('div');
      div.className = 'message ai';
      div.id = 'typingIndicator';
      div.innerHTML = `
        <div class="avatar ai-avatar">‚öñÔ∏è</div>
        <div class="bubble">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>`;
      document.getElementById('chatArea').appendChild(div);
      scrollToBottom();
    }
    function removeTyping() {
      const t = document.getElementById('typingIndicator');
      if (t) t.remove();
    }

    function setStatus(loading) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const send = document.getElementById('sendBtn');
      if (loading) {
        dot.style.background = 'var(--gold)';
        text.textContent = 'Analyse en cours...';
        send.disabled = true;
      } else {
        dot.style.background = 'var(--green)';
        text.textContent = 'Pr√™t';
        send.disabled = false;
      }
    }

    function updateModeBadge(type) {
      const badge = document.getElementById('modeBadge');
      const cardQ = document.getElementById('card-question');
      const cardC = document.getElementById('card-consultation');
      if (type === 'consultation') {
        badge.className = 'mode-badge consultation';
        badge.textContent = 'Consultation';
        cardC.classList.add('active');
        cardQ.classList.remove('active');
      } else {
        badge.className = 'mode-badge question';
        badge.textContent = 'Question';
        cardQ.classList.add('active');
        cardC.classList.remove('active');
      }
    }

    function newConversation() {
      history = [];
      sessionId = 'session_' + Date.now();
      const chatArea = document.getElementById('chatArea');

      // Remove all messages
      while (chatArea.firstChild) chatArea.removeChild(chatArea.firstChild);

      // Re-add welcome
      const welcome = document.createElement('div');
      welcome.className = 'welcome';
      welcome.id = 'welcome';
      welcome.innerHTML = `
        <div class="welcome-icon">‚öñÔ∏è</div>
        <h2>Bienvenue, je suis Ma√Ætre Sall</h2>
        <p>Votre conseiller juridique IA, expert en droit s√©n√©galais.<br>
        Je peux r√©pondre √† vos <strong style="color:#58a6ff">questions de droit</strong> ou analyser
        votre <strong style="color:var(--gold)">situation juridique</strong> et vous proposer des orientations.</p>
        <div class="welcome-examples">
          <div class="example-chip" onclick="sendExample(this.dataset.q)" data-q="Quelle est la dur√©e l√©gale de la garde √† vue au S√©n√©gal ?">
            <strong>üîµ Question Juridique</strong>Quelle est la dur√©e l√©gale de la garde √† vue au S√©n√©gal ?
          </div>
          <div class="example-chip" onclick="sendExample(this.dataset.q)" data-q="Mon employeur m'a licenci√© sans pr√©avis apr√®s 5 ans de service. Il refuse de me payer mes indemnit√©s et a d√©truit mon contrat de travail.">
            <strong>üü° Consultation ‚Äì Droit du Travail</strong>Mon employeur m'a licenci√© sans pr√©avis apr√®s 5 ans de service. Il refuse de me payer mes indemnit√©s et a d√©truit mon contrat de travail.
          </div>
        </div>`;
      chatArea.appendChild(welcome);

      updateModeBadge('question');
      if (currentSpeech) window.speechSynthesis.cancel();
    }

    // ========== UTILS ==========
    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    function scrollToBottom() {
      const area = document.getElementById('chatArea');
      setTimeout(() => area.scrollTop = area.scrollHeight, 50);
    }

    function detectType(message) {
      const factual = /(j'ai |on m'a |mon |ma |j'√©tais|j'ai √©t√©|mon employeur|ma femme|mon mari)/i;
      return factual.test(message) && message.length > 80 && !message.trim().endsWith('?')
        ? 'consultation' : 'question';
    }

    function escapeHtml(text) {
      return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function parseMarkdown(text) {
      return escapeHtml(text)
        .replace(/^#{1,3}\s+(.+)$/gm, '<strong style="color:var(--gold-light);display:block;margin:10px 0 4px;">$1</strong>')
        .replace(/\*\*([^*\n]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*\n]+)\*/g, '<em>$1</em>')
        .replace(/^[-‚Ä¢]\s+(.+)$/gm, '<li style="margin:3px 0;">$1</li>')
        .replace(/(<li.*<\/li>\n?)+/g, '<ul style="padding-left:16px;margin:6px 0;">$&</ul>')
        .replace(/\n{2,}/g, '</p><p style="margin-top:8px;">')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>').replace(/$/, '</p>');
    }

    function showNotification(msg, type = 'info') {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      const n = document.createElement('div');
      n.className = `notification ${type}`;
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 4000);
    }

    // Load voices on ready
    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = () => {};
      speechSynthesis.getVoices();
    }
  </script>
</body>
</html>
